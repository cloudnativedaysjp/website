---
import * as path from 'path'
import { Icon } from "astro-icon/components";
import Headline from "../../../components/Headline.astro";
import { speakerMap } from "../../../data/data";
import { talkMap } from "../../../data/data";
import { Conferences } from "../../../data/data";
import Layout from "../../../layouts/Layout.astro";
import type { Speaker } from "../../../types/speaker";
import { getSlideEmbed } from "../../../lib/oembed";

export async function getStaticPaths() {
  return [...talkMap.entries()].flatMap((a) => {
    const abbr = a[0];
    const talks = a[1];
    return talks.map((talk) => {
      return { params: { abbr: abbr, id: talk.id } };
    });
  });
}
const { abbr, id } = Astro.params;
const talk = talkMap.get(abbr || "")?.find((talk) => {
  return talk.id == Number(id);
});

const isSpeaker = (item: Speaker | undefined): item is Speaker => {
  return !!item;
};

const speakers: Speaker[] =
  talk?.speakers
    .map((speaker) => speaker.id)
    .map((id) => {
      const speaker = speakerMap.get(abbr || "")?.find((speaker) => {
        return speaker.id == id;
      });
      return speaker;
    })
    .filter(isSpeaker) || [];

const talkExists = talk != undefined;
const speakersExists = speakers?.length > 0;
const conference = Conferences.find((conference) => conference.abbr == abbr);

const title = talk?.title || "";
const description = talk?.abstract || "";
const ogImage = conference?.image || "/favicon.svg";

// Get slide embed data if documentUrl exists
const slideEmbed = talk?.documentUrl ? await getSlideEmbed(talk.documentUrl) : null;
---

<Layout title={title} description={description} ogImage={ogImage}>
  <main>
    {
      talkExists && (
        <div>
          <div class="pt-16 mx-auto max-w-4xl px-4">
            {/* ナビゲーション */}
            <nav class="mb-6">
              <a
                href={`/${abbr}#sessions`}
                class="inline-flex items-center gap-2 text-gray-600 hover:text-indigo-600 transition-colors"
              >
                <Icon name="tabler:arrow-left" class="w-5 h-5" />
                <span>{conference?.name || 'イベント'}のセッション一覧に戻る</span>
              </a>
            </nav>
            <div class="relative flex flex-col min-w-0 break-words bg-white/60 backdrop-blur-sm w-full mb-4 rounded-xl">
              <div class="px-4 py-5 flex-auto">
                {path.extname(talk.videoId) == ".m3u8" ?
                  <div>
                    <video
                      id="my-player"
                      class="video-js video-js vjs-16-9 vjs-big-play-centered"
                      data-setup='{"fluid": true}'
                      controls
                      preload="auto"
                    >
                      <source src={talk.videoId} type="application/x-mpegURL" />
                    </video>
                  </div>
                  :
                  <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%;">
                    <iframe
                      src={talk.videoId}
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                    </iframe>
                  </div>
                }
              </div>
              {/* 資料セクション */}
              {slideEmbed && (
                <div class="mt-4">
                  {slideEmbed.html ? (
                    <div class="slide-embed-container">
                      <div class="flex items-center justify-between mb-3 px-1">
                        <div class="flex items-center gap-2">
                          <Icon name="tabler:presentation" class="w-5 h-5 text-indigo-600" />
                          <span class="font-bold text-gray-800">Slides</span>
                          <span class="text-sm text-gray-500">({slideEmbed.provider})</span>
                        </div>
                        <a
                          href={slideEmbed.url}
                          target="_blank"
                          rel="noopener noreferrer"
                          class="flex items-center gap-1 text-sm text-indigo-600 hover:text-indigo-800 transition-colors"
                        >
                          <span>Open in new tab</span>
                          <Icon name="tabler:external-link" class="w-4 h-4" />
                        </a>
                      </div>
                      <div class="bg-white/60 backdrop-blur-sm rounded-xl overflow-hidden border border-gray-200">
                        <Fragment set:html={slideEmbed.html} />
                      </div>
                    </div>
                  ) : (
                    <a
                      href={slideEmbed.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="flex items-center gap-3 p-4 bg-white/60 backdrop-blur-sm rounded-xl hover:bg-white/80 transition-all duration-300 border border-gray-200"
                    >
                      <div class="flex-shrink-0 w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center">
                        <Icon name="tabler:presentation" class="w-6 h-6 text-indigo-600" />
                      </div>
                      <div class="flex-grow text-left">
                        <p class="font-bold text-gray-800">Slides</p>
                        <p class="text-sm text-gray-500">{slideEmbed.provider}</p>
                      </div>
                      <Icon name="tabler:external-link" class="w-5 h-5 text-gray-400" />
                    </a>
                  )}
                </div>
              )}
            </div>
              <div class="relative flex flex-col min-w-0 break-words bg-white/60 backdrop-blur-sm w-full mb-8 rounded-xl">
                <div>
                  <div class="py-8 px-8 text-left">
                    <h2 class="text-3xl font-bold">{title}</h2>
                    <p class="mt-6 text-lg whitespace-pre-line leading-relaxed">
                      {description}
                    </p>
                  </div>
                </div>
                {speakersExists &&
                <div>
                <hr class="mx-8 border-t-1 border-gray-300" />
                {speakers?.map((speaker) => {
                  return (
                    <div class="p-8">
                      <div class="flex flex-col items-start">
                        <div class="mr-16 mb-4 text-left">
                          <div class="flex items-center">
                            <Icon name="tabler:user" class="w-6 h-6 mr-1 text-gray-600" />
                            <span class="text-2xl font-bold">{speaker.name}</span>
                          </div>
                          <p class="mr-6">{speaker.company}</p>
                          <p>{speaker.jobTitle}</p>
                        </div>
                        <div class="mr-16 text-left">
                          <div class="flex flex-wrap">
                            {speaker.twitterId && (
                              <a
                                href={`https://x.com/${speaker.twitterId}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex items-center mb-2 hover:text-indigo-600 transition-colors"
                              >
                                <Icon name="tabler:brand-x" class="w-5 h-5 mr-1 text-gray-800" />
                                <p class="mr-6 text-center">{speaker.twitterId}</p>
                              </a>
                            )}
                            {speaker.githubId && (
                              <a
                                href={`https://github.com/${speaker.githubId}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="flex items-center mb-2 hover:text-indigo-600 transition-colors"
                              >
                                <Icon name="tabler:brand-github" class="w-5 h-5 mr-1 text-gray-800" />
                                <p class="mr-6 text-center">{speaker.githubId}</p>
                              </a>
                            )}
                          </div>
                        </div>
                      </div>
                      <div class="mr-16 text-left">
                        <p>{speaker.profile}</p>
                      </div>
                    </div>
                  )
                })}
              </div>
            }
          </div>
        </div>
      </div>
      )
    }
  </main>
</Layout>

<style>
  .slide-embed-container :global(iframe) {
    width: 100%;
    aspect-ratio: 16 / 9;
    height: auto;
    border: none;
  }
</style>
